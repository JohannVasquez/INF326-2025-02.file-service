name: Expose service and update DNS

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

env:
  # Defaults; override via repository secrets if needed
  INGRESS_NAMESPACE: ingress-nginx
  INGRESS_SERVICE_NAME: ingress-nginx-controller
  INGRESS_HOST: file-service.inf326.cl
  SERVICE_NAMESPACE: file-service

jobs:
  expose-and-dns:
    runs-on: ubuntu-latest
    env:
      DO_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}            # DigitalOcean API token (required)
      INGRESS_NAMESPACE: ${{ env.INGRESS_NAMESPACE }}
      INGRESS_SERVICE_NAME: ${{ env.INGRESS_SERVICE_NAME }}
      INGRESS_HOST: ${{ env.INGRESS_HOST }}
      SERVICE_NAMESPACE: ${{ env.SERVICE_NAMESPACE }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install gettext (envsubst)
      run: |
        sudo apt-get update -y
        sudo apt-get install -y gettext-base

    - name: Configure kubectl (generate kubeconfig from template)
      env:
        DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
        K8S_CLUSTER_CA_DATA: ${{ secrets.K8S_CLUSTER_CA_DATA }}
        K8S_CLUSTER_SERVER: ${{ secrets.K8S_CLUSTER_SERVER }}
        K8S_CLUSTER_NAME: ${{ secrets.K8S_CLUSTER_NAME }}
        K8S_USER_NAME: ${{ secrets.K8S_USER_NAME }}
      run: |
        set -e
        echo "Generating kubeconfig from template"
        mkdir -p $HOME/.kube
        # Debug: show template head
        echo "=== Kubeconfig template (first lines) ==="
        head -n 50 k8s-inf326-nyc1-kubeconfig.yaml || true
        envsubst < k8s-inf326-nyc1-kubeconfig.yaml > $HOME/.kube/config
        chmod 600 $HOME/.kube/config
        echo "Generated kubeconfig size: $(wc -c < $HOME/.kube/config) bytes"

    - name: Install jq
      run: |
        sudo apt-get update -y
        sudo apt-get install -y jq

    - name: Wait for Ingress controller external IP
      id: wait_ingress
      run: |
        set -e
        echo "Waiting for external IP on service $INGRESS_SERVICE_NAME in namespace $INGRESS_NAMESPACE"
        INGRESS_IP=""
        for i in $(seq 1 30); do
          # try ip then hostname
          INGRESS_IP=$(kubectl get svc $INGRESS_SERVICE_NAME -n $INGRESS_NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)
          if [ -z "$INGRESS_IP" ]; then
            INGRESS_IP=$(kubectl get svc $INGRESS_SERVICE_NAME -n $INGRESS_NAMESPACE -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || true)
          fi
          if [ -n "$INGRESS_IP" ]; then
            echo "Found ingress IP/hostname: $INGRESS_IP"
            echo "INGRESS_IP=$INGRESS_IP" >> $GITHUB_ENV
            echo "ingress_ip=$INGRESS_IP" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Attempt $i: not ready yet..."
          sleep 10
        done
        echo "Timed out waiting for ingress external IP" >&2
        exit 1

    - name: Create/Update DigitalOcean A record for host
      env:
        DO_TOKEN: ${{ env.DO_TOKEN }}
        INGRESS_IP: ${{ env.INGRESS_IP }}
        INGRESS_HOST: ${{ env.INGRESS_HOST }}
      run: |
        set -e
        if [ -z "$INGRESS_IP" ]; then
          echo "INGRESS_IP not set"; exit 1
        fi

        DOMAIN="${INGRESS_HOST#*.}"
        SUBDOMAIN="${INGRESS_HOST%%.*}"

        echo "Domain: $DOMAIN  Subdomain: $SUBDOMAIN  IP: $INGRESS_IP"

        # Check existing A record
        RECORDS=$(curl -s -X GET "https://api.digitalocean.com/v2/domains/$DOMAIN/records" -H "Authorization: Bearer $DO_TOKEN")
        EXISTING_ID=$(echo "$RECORDS" | jq -r '.domain_records[] | select(.type=="A" and .name=="'"$SUBDOMAIN"'") | .id' || true)

        if [ -n "$EXISTING_ID" ] && [ "$EXISTING_ID" != "null" ]; then
          echo "Updating existing A record id=$EXISTING_ID to $INGRESS_IP"
          curl -s -X PUT "https://api.digitalocean.com/v2/domains/$DOMAIN/records/$EXISTING_ID" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DO_TOKEN" \
            -d '{"data":"'"$INGRESS_IP"'"}'
        else
          echo "Creating A record $SUBDOMAIN.$DOMAIN -> $INGRESS_IP"
          curl -s -X POST "https://api.digitalocean.com/v2/domains/$DOMAIN/records" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DO_TOKEN" \
            -d '{"type":"A","name":"'"$SUBDOMAIN"'","data":"'"$INGRESS_IP"'","ttl":1800}'
        fi

    - name: Output final info
      run: |
        echo "Ingress host: $INGRESS_HOST"
        echo "Ingress IP/hostname: $INGRESS_IP"
        echo "You can now access: http://$INGRESS_HOST"
